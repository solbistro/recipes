<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é›å°¾é…’è­œç€è¦½</title>

    <!-- PWA Meta -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="é›å°¾é…’è­œ">
    <link rel="apple-touch-icon" href="icons/icon-192.png">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, .3);
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: .9;
            margin-bottom: 30px;
        }

        .age-warning {
            background: rgba(255, 193, 7, .9);
            color: #856404;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 500;
            backdrop-filter: blur(10px);
        }

        .install-prompt {
            background: rgba(72, 187, 120, .9);
            color: #fff;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 500;
            backdrop-filter: blur(10px);
            display: none;
        }

        .install-btn {
            background: #fff;
            color: #48bb78;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            margin-left: 10px;
            cursor: pointer;
            font-weight: 600;
        }

        .install-btn:hover {
            background: #f7fafc;
        }

        .offline-indicator {
            background: rgba(245, 101, 101, .9);
            color: #fff;
            padding: 8px 16px;
            border-radius: 6px;
            margin-bottom: 16px;
            text-align: center;
            display: none;
            backdrop-filter: blur(10px);
        }

        .connection-status {
            background: rgba(255, 255, 255, .1);
            color: #fff;
            padding: 8px 16px;
            border-radius: 6px;
            margin-bottom: 16px;
            text-align: center;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
        }

        .connection-status.success {
            background: rgba(72, 187, 120, .9);
        }

        .connection-status.error {
            background: rgba(245, 101, 101, .9);
        }

        .connection-status.warning {
            background: rgba(255, 193, 7, .9);
            color: #856404;
        }

        /* ç®¡ç†å“¡èªè­‰ UI æ¨£å¼ */
        .admin-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.1);
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .admin-status-text {
            font-size: 0.85rem;
            color: #4a5568;
            font-weight: 500;
            min-width: 80px;
        }

        .admin-mode .admin-controls {
            background: rgba(72, 187, 120, 0.15);
            border-color: rgba(72, 187, 120, 0.3);
        }

        .admin-mode .admin-status-text {
            color: #2f855a;
        }

        .guest-mode .admin-controls {
            background: rgba(160, 174, 192, 0.15);
            border-color: rgba(160, 174, 192, 0.3);
        }

        .admin-login-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .admin-login-modal.show {
            display: flex;
        }

        .admin-login-form {
            background: white;
            padding: 32px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            width: min(400px, 90vw);
            max-height: 90vh;
            overflow-y: auto;
        }

        .admin-login-form h3 {
            margin: 0 0 24px 0;
            text-align: center;
            color: #2d3748;
        }

        .admin-login-form .form-group {
            margin-bottom: 20px;
        }

        .admin-login-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #4a5568;
        }

        .admin-login-form input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .admin-login-form input:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }

        .admin-login-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .admin-login-actions button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-login {
            background: #4299e1;
            color: white;
        }

        .btn-login:hover {
            background: #3182ce;
        }

        .btn-cancel {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-cancel:hover {
            background: #cbd5e0;
        }

        .admin-error {
            background: #fed7d7;
            color: #822727;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 0.9rem;
        }

        .admin-success {
            background: #c6f6d5;
            color: #2f855a;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 0.9rem;
        }

        /* éš±è—ç·¨è¼¯åŠŸèƒ½çš„æ¨£å¼ */
        .guest-mode .edit-only {
            display: none !important;
        }

        .guest-mode .cocktail-card .btn {
            display: none !important;
        }

        .edit-disabled {
            opacity: 0.5;
            pointer-events: none;
            user-select: none;
        }

        .filters {
            background: rgba(255, 255, 255, .1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, .1);
        }

        .filter-row {
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 15px;
            align-items: center;
        }

        input[type="text"],
        select,
        input[type="number"],
        input[type="url"],
        textarea {
            padding: 12px 16px;
            border: none;
            border-radius: 12px;
            background: rgba(255, 255, 255, .9);
            font-size: 1rem;
            transition: .3s;
            width: 100%;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            background: #fff;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, .15);
        }

        .view-toggle {
            display: flex;
            background: rgba(255, 255, 255, .2);
            border-radius: 12px;
            overflow: hidden;
        }

        .view-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: #fff;
            cursor: pointer;
            transition: .3s;
        }

        .view-btn.active {
            background: rgba(255, 255, 255, .3);
        }

        .stats {
            text-align: center;
            color: rgba(255, 255, 255, .8);
            margin-bottom: 25px;
            font-size: .9rem;
        }

        .cocktails-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .cocktails-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }

        .cocktail-card {
            background: #fff;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, .1);
            transition: .3s;
            animation: fadeIn .5s ease;
        }

        .cocktail-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, .15);
        }

        .cocktail-image {
            width: 100%;
            aspect-ratio: 16/9;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: 12px;
            font-size: 2rem;
        }

        .cocktail-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .cocktail-content {
            padding: 20px;
        }

        .cocktail-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2d3748;
            flex: 1;
            margin: 0 0 8px 0;
        }

        .cocktail-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 12px;
            font-size: .85rem;
            color: #718096;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .cocktail-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 15px;
        }

        .tag {
            background: #e2e8f0;
            color: #4a5568;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: .75rem;
            font-weight: 500;
        }

        details {
            margin-bottom: 8px;
        }

        summary {
            cursor: pointer;
            font-weight: 500;
            color: #4299e1;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        summary:hover {
            color: #3182ce;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .nav-btn {
            background: rgba(255, 255, 255, .2);
            border: none;
            color: #fff;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            transition: .3s;
            font-size: 1rem;
            font-weight: 500;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, .3);
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: rgba(255, 255, 255, .4);
            box-shadow: 0 4px 15px rgba(0, 0, 0, .2);
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: rgba(255, 255, 255, .7);
        }

        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: rgba(255, 255, 255, .8);
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, .3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        .add-cocktail-form {
            text-align: left;
        }

        .form-section {
            background: rgba(255, 255, 255, .1);
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
        }

        .form-section h3 {
            color: #fff;
            margin-bottom: 16px;
            font-size: 1.1rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group label {
            color: rgba(255, 255, 255, .9);
            font-weight: 500;
            margin-bottom: 6px;
        }

        .ingredient-item,
        .instruction-item {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
        }

        .ingredient-item input,
        .instruction-item input {
            flex: 1;
        }

        .add-btn,
        .remove-btn,
        .btn {
            cursor: pointer;
            border: none;
            border-radius: 12px;
            padding: 8px 16px;
            font-weight: 500;
            transition: .3s;
        }

        .add-btn {
            background: rgba(255, 255, 255, .9);
            color: #2d3748;
            margin-top: 8px;
        }

        .add-btn:hover {
            background: #fff;
            transform: translateY(-1px);
        }

        .remove-btn {
            background: #fed7d7;
            color: #822727;
            padding: 6px 12px;
            font-size: .85rem;
        }

        .remove-btn:hover {
            background: #fbb6ce;
        }

        .btn-primary {
            background: #4299e1;
            color: #fff;
            padding: 12px 24px;
        }

        .btn-primary:hover {
            background: #3182ce;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, .2);
            color: #fff;
            padding: 12px 24px;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, .3);
        }

        .btn-danger {
            background: #ffd6d6;
            color: #822727;
        }

        .btn-danger:hover {
            background: #fbb6ce;
        }

        .topbar {
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: rgba(255, 255, 255, .95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 0, 0, .06);
            box-shadow: 0 2px 10px rgba(0, 0, 0, .1);
        }

        .brand {
            font-weight: 600;
            color: #2d3748;
            font-size: 1.1rem;
        }

        .topbar .actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .drawer {
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            width: min(420px, 95vw);
            background: #fff;
            box-shadow: -8px 0 30px rgba(0, 0, 0, .15);
            padding: 20px;
            overflow: auto;
            z-index: 1001;
            transform: translateX(100%);
            transition: .3s;
        }

        .drawer:not(.hidden) {
            transform: translateX(0);
        }

        .drawer.hidden {
            transform: translateX(100%);
        }

        .drawer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e2e8f0;
        }

        .drawer-header h3 {
            margin: 0;
            color: #2d3748;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .btn-close {
            background: #f56565;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .btn-close:hover {
            background: #e53e3e;
            transform: scale(1.1);
        }

        .edit-form label {
            display: block;
            margin: 16px 0 6px;
            font-size: 14px;
            font-weight: 500;
            color: #4a5568;
        }

        .edit-form input,
        .edit-form textarea,
        .edit-form select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            background: #fff;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .drawer-actions {
            display: flex;
            gap: 8px;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #e2e8f0;
            flex-wrap: wrap;
        }

        .drawer-actions .btn {
            flex: 1;
            min-width: 100px;
        }

        #imagePreview img,
        #addImagePreview img {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, .1);
        }

        #addImagePreview {
            padding: 8px 0;
            text-align: center;
        }

        #imagePreview {
            margin: 8px 0;
        }

        .debug-panel {
            background: rgba(0, 0, 0, .8);
            color: #fff;
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
            font-family: monospace;
            font-size: 0.85rem;
            line-height: 1.4;
            max-height: 200px;
            overflow-y: auto;
        }

        .debug-panel h4 {
            margin: 0 0 8px 0;
            color: #ffd700;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 480px) {
            .drawer-actions {
                flex-direction: column;
            }
            
            .drawer-actions .btn {
                width: 100%;
            }
        }

        @media (max-width:768px) {
            #cocktailsContainer.cocktails-grid {
                grid-template-columns: 1fr !important;
            }

            .filter-row {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .topbar {
                flex-direction: column;
                gap: 12px;
                padding: 16px;
            }
            
            .topbar .actions {
                margin-right: 0; /* æ‰‹æ©Ÿç‰ˆç§»é™¤å³é‚Šè· */
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .admin-controls {
                order: -1; /* åœ¨æ‰‹æ©Ÿç‰ˆæ™‚é¡¯ç¤ºåœ¨æœ€ä¸Šæ–¹ */
                margin-bottom: 8px;
            }

            .nav-tabs {
                flex-direction: column;
                align-items: center;
                gap: 8px;
            }

            .nav-btn {
                width: 200px;
            }

            .drawer {
                width: 100vw;
            }

            .form-actions {
                flex-direction: column;
            }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>
    <!-- ç®¡ç†å“¡ç™»å…¥å½ˆçª— -->
    <div id="adminLoginModal" class="admin-login-modal">
        <div class="admin-login-form">
            <h3>ğŸ” ç®¡ç†å“¡ç™»å…¥</h3>
            <div id="adminLoginError" class="admin-error" style="display: none;"></div>
            <div id="adminLoginSuccess" class="admin-success" style="display: none;"></div>
            
            <form id="adminLoginForm">
                <div class="form-group">
                    <label for="adminUsername">ç”¨æˆ¶å</label>
                    <input type="text" id="adminUsername" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="adminPassword">å¯†ç¢¼</label>
                    <input type="password" id="adminPassword" required autocomplete="current-password">
                </div>
                <div class="admin-login-actions">
                    <button type="submit" class="btn-login">ç™»å…¥</button>
                    <button type="button" class="btn-cancel" onclick="adminAuth.hideLoginModal()">å–æ¶ˆ</button>
                </div>
            </form>
            
            <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid #e2e8f0; font-size: 0.85rem; color: #718096; text-align: center;">
                <p>âš ï¸ ç®¡ç†å“¡æ¨¡å¼æ‰èƒ½ç·¨è¼¯å’Œåˆªé™¤é…’è­œ</p>
                <p>é è¨­å¸³è™Ÿï¼šadmin / cocktail2024</p>
                <p>ï¼ˆé¦–æ¬¡ä½¿ç”¨è«‹å‹™å¿…ä¿®æ”¹å¯†ç¢¼ï¼‰</p>
            </div>
        </div>
    </div>

    <!-- PWA å®‰è£æç¤º -->
    <div id="installPrompt" class="install-prompt">
        <span>ğŸ¸ å°‡é›å°¾é…’è­œå®‰è£åˆ°æ‚¨çš„æ‰‹æ©Ÿï¼Œéš¨æ™‚é›¢ç·šä½¿ç”¨ï¼</span>
        <button id="installBtn" class="install-btn">ç«‹å³å®‰è£</button>
        <button onclick="this.parentElement.style.display='none'" class="install-btn"
            style="background:#f56565;color:white;">ç¨å¾Œ</button>
    </div>

    <!-- é›¢ç·šç‹€æ…‹æŒ‡ç¤º -->
    <div id="offlineIndicator" class="offline-indicator">ğŸ“¡ ç›®å‰è™•æ–¼é›¢ç·šæ¨¡å¼ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½å—é™</div>

    <!-- é€£ç·šç‹€æ…‹æŒ‡ç¤º -->
    <div id="connectionStatus" class="connection-status hidden">æ­£åœ¨æª¢æŸ¥é€£ç·šç‹€æ…‹...</div>

    <header class="topbar">
        <div class="brand">é›å°¾é…’è­œ WebApp</div>
        <div class="actions">
            <button id="btnSync" class="btn btn-primary" type="button">ğŸ”„ åŒæ­¥ï¼ˆå¾é›²ç«¯è®€å–ï¼‰</button>
            <button id="btnClearData" class="btn btn-danger" type="button">ğŸ—‘ï¸ æ¸…é™¤æœ¬æ©Ÿå¿«å–</button>
            
            <!-- ç®¡ç†å“¡æ§åˆ¶æ•´åˆ -->
            <div id="adminControls" class="admin-controls guest-mode">
                <span id="adminStatusText" class="admin-status-text">è¨ªå®¢æ¨¡å¼</span>
                <button id="adminLoginBtn" class="btn btn-primary" style="padding: 6px 12px; font-size: 0.85rem;">ç®¡ç†å“¡ç™»å…¥</button>
                <button id="adminLogoutBtn" class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.85rem; display: none;">ç™»å‡º</button>
            </div>
        </div>
    </header>

    <div class="container">
        <header>
            <h1>ğŸ¸ é›å°¾é…’è­œç€è¦½</h1>
            <p class="subtitle">æ¢ç´¢ç¶“å…¸èª¿é…’ï¼Œäº«å—å“å‘³æ™‚å…‰</p>
            <div class="age-warning">âš ï¸ æœªæ»¿18æ­²è«‹å‹¿é£²é…’ï¼Œé£²é…’éé‡æœ‰å®³å¥åº·</div>
            <nav class="nav-tabs">
                <button class="nav-btn active" data-page="browse" type="button">ğŸ“– ç€è¦½é…’è­œ</button>
                <button class="nav-btn" data-page="add" type="button">â• æ–°å¢é…’è­œ</button>
                <button class="nav-btn" data-page="settings" type="button">âš™ï¸ è¨­å®š</button>
            </nav>
        </header>

        <!-- ç€è¦½å€ -->
        <div class="page active" id="browsePage">
            <div class="filters">
                <div class="filter-row">
                    <input type="text" id="searchInput" placeholder="ğŸ” æœå°‹é›å°¾é…’ã€åŸºé…’æˆ–æ¨™ç±¤..." />
                    <select id="categorySelect">
                        <option value="">ğŸ“‹ å…¨éƒ¨åˆ†é¡</option>
                    </select>
                    <div class="view-toggle">
                        <button class="view-btn active" data-view="grid" type="button">ç¶²æ ¼</button>
                        <button class="view-btn" data-view="list" type="button">åˆ—è¡¨</button>
                    </div>
                </div>
            </div>
            <div class="stats" id="stats">è¼‰å…¥ä¸­...</div>
            <div id="cocktailsContainer" class="cocktails-grid">
                <div class="loading">æ­£åœ¨è¼‰å…¥é›å°¾é…’è³‡æ–™</div>
            </div>
        </div>

        <!-- æ–°å¢å€ -->
        <div class="page" id="addPage">
            <div class="add-cocktail-form">
                <div class="success-message" id="successMessage"
                    style="display:none;background:rgba(72,187,120,.9);color:#fff;padding:16px 20px;border-radius:12px;margin-bottom:20px;font-weight:600;backdrop-filter:blur(10px);">
                    âœ… é›å°¾é…’è­œæ–°å¢æˆåŠŸï¼
                </div>

                <form id="addCocktailForm">
                    <div class="form-section">
                        <h3>ğŸ“„ åŸºæœ¬è³‡è¨Š</h3>
                        <div class="form-group">
                            <label for="cocktailTitle">é›å°¾é…’åç¨± *</label>
                            <input type="text" id="cocktailTitle" required placeholder="ä¾‹å¦‚ï¼šè«å¸Œæ‰˜ã€é¦¬ä¸å°¼" />
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="cocktailCategory">åˆ†é¡</label>
                                <select id="cocktailCategory">
                                    <option value="">é¸æ“‡åˆ†é¡</option>
                                    <option value="ç¶“å…¸é›å°¾é…’">ç¶“å…¸é›å°¾é…’</option>
                                    <option value="ç„¡é…’ç²¾èª¿é£²">ç„¡é…’ç²¾ç‰¹èª¿</option>
                                    <option value="ç‰¹èª¿é›å°¾é…’">ç‰¹èª¿é›å°¾é…’</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="glassType">æ¯å‹</label>
                                <select id="glassType">
                                    <option value="">é¸æ“‡æ¯å‹</option>
                                    <option value="é¦¬ä¸å°¼æ¯">é¦¬ä¸å°¼æ¯</option>
                                    <option value="å¨å£«å¿Œæ¯">å¨å£«å¿Œæ¯</option>
                                    <option value="é«˜çƒæ¯">é«˜çƒæ¯</option>
                                    <option value="å²©çŸ³æ¯">å²©çŸ³æ¯</option>
                                    <option value="é¦™æª³æ¯">é¦™æª³æ¯</option>
                                    <option value="é¢¶é¢¨æ¯">é¢¶é¢¨æ¯</option>
                                    <option value="é›å°¾é…’æ¯">é›å°¾é…’æ¯</option>
                                    <option value="æŸ¯æ—æ¯">æŸ¯æ—æ¯</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="alcoholContent">é…’ç²¾æ¿ƒåº¦</label>
                                <select id="alcoholContent">
                                    <option value="">é¸æ“‡æ¿ƒåº¦</option>
                                    <option value="ä½">æ¿ƒåº¦ä½</option>
                                    <option value="ä¸­">æ¿ƒåº¦ä¸­</option>
                                    <option value="é«˜">æ¿ƒåº¦é«˜</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="difficulty">é›£åº¦ç­‰ç´š</label>
                                <select id="difficulty">
                                    <option value="">é¸æ“‡é›£åº¦</option>
                                    <option value="ç°¡å–®">ç°¡å–®</option>
                                    <option value="ä¸­ç­‰">ä¸­ç­‰</option>
                                    <option value="å›°é›£">å›°é›£</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="servings">ä»½é‡</label>
                                <input type="number" id="servings" min="1" placeholder="1" />
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>ğŸ·ï¸ æ¨™ç±¤</h3>
                        <div class="tags-input">
                            <input type="text" id="tagsInput" placeholder="è¼¸å…¥æ¨™ç±¤å¾ŒæŒ‰ Enterï¼ˆä¾‹å¦‚ï¼šæ¸…çˆ½ã€å¤æ—¥ï¼‰" />
                            <div class="tags-display" id="tagsDisplay"></div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>ğŸ¥ƒ é…æ–™æ¸…å–®</h3>
                        <div class="ingredients-list" id="ingredientsList">
                            <div class="ingredient-item">
                                <input type="text" placeholder="ä¾‹å¦‚ï¼šç™½è˜­åœ° 60ml" required />
                                <button type="button" class="remove-btn"
                                    onclick="app.removeIngredient(this)">ç§»é™¤</button>
                            </div>
                        </div>
                        <button type="button" class="add-btn" onclick="app.addIngredient()">â• æ–°å¢é…æ–™</button>
                    </div>

                    <div class="form-section">
                        <h3>ğŸ´ èª¿è£½æ–¹æ³•</h3>
                        <div class="instructions-list" id="instructionsList">
                            <div class="instruction-item">
                                <span style="font-weight: bold; min-width: 30px;">1.</span>
                                <input type="text" placeholder="è©³ç´°æè¿°ç¬¬ä¸€å€‹æ­¥é©Ÿ" required />
                                <button type="button" class="remove-btn"
                                    onclick="app.removeInstruction(this)">ç§»é™¤</button>
                            </div>
                        </div>
                        <button type="button" class="add-btn" onclick="app.addInstruction()">â• æ–°å¢æ­¥é©Ÿ</button>
                    </div>

                    <div class="form-section">
                        <h3>ğŸ–¼ï¸ ä¸Šå‚³åœ–ç‰‡ï¼ˆé¸å¡«ï¼‰</h3>
                        <div class="form-group">
                            <label for="cocktailImageFile">é¸æ“‡åœ–ç‰‡æª”æ¡ˆ</label>
                            <input type="file" id="cocktailImageFile" accept="image/*" />
                            <div id="addImagePreview" style="margin-top: 12px;"></div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="app.clearForm()">æ¸…ç©ºè¡¨å–®</button>
                        <button type="submit" class="btn btn-primary">ğŸ’¾ å„²å­˜åˆ°é›²ç«¯</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- è¨­å®šå€ -->
        <div class="page" id="settingsPage">
            <div class="form-section">
                <h3>ğŸŒ GAS é€£ç·š</h3>
                <div class="form-group">
                    <label for="gasUrl">Web App URLï¼ˆä¾‹ï¼šhttps://script.google.com/macros/s/XXX/execï¼‰</label>
                    <input type="url" id="gasUrl" placeholder="è²¼ä¸Šä½ çš„ GAS Web App URL" value="https://script.google.com/macros/s/AKfycbwrnq0RFdvxJc0iT02gI9VTRcwxWhVmO3-tARoJFtn6FDyijEJo4AcLPjCkQ4fXcDHYOA/exec">
                </div>
                <div class="form-actions">
                    <button class="btn btn-primary" id="btnSaveGasUrl">å„²å­˜é€£ç·šè¨­å®š</button>
                    <button class="btn btn-secondary" id="btnTestGas">æ¸¬è©¦é€£ç·š</button>
                </div>
                
                <!-- èª¿è©¦è³‡è¨Š -->
                <div id="debugInfo" class="debug-panel hidden">
                    <h4>é€£ç·šèª¿è©¦è³‡è¨Š</h4>
                    <div id="debugContent">å°šæœªé€²è¡Œé€£ç·šæ¸¬è©¦</div>
                </div>
            </div>

            <div class="form-section">
                <h3>ğŸ“Š å„²å­˜çµ±è¨ˆ</h3>
                <div id="storageStats" style="color: white; line-height: 1.6;">è¼‰å…¥ä¸­...</div>
            </div>

            <div class="form-section">
                <h3>â„¹ï¸ æ‡‰ç”¨ç¨‹å¼è³‡è¨Š</h3>
                <div style="color: rgba(255,255,255,0.8); line-height: 1.6;">
                    <p><strong>ç‰ˆæœ¬ï¼š</strong> 2.2ï¼ˆæ•´åˆç®¡ç†å“¡èªè­‰ç³»çµ±ï¼‰</p>
                    <p><strong>å„²å­˜æ–¹å¼ï¼š</strong> é›²ç«¯ï¼ˆGASï¼‰ï¼‹ æœ¬æ©Ÿ IndexedDB åœ–ç‰‡å¿«å–</p>
                    <p><strong>æ”¯æ´åŠŸèƒ½ï¼š</strong> é›¢ç·šç€è¦½ã€é›²ç«¯åŒæ­¥ã€åœ–ç‰‡å¿«å–ã€ç®¡ç†å“¡èªè­‰</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ç·¨è¼¯æŠ½å±œ - å¢å¼·ç‰ˆ -->
    <aside id="editDrawer" class="drawer hidden" aria-hidden="true">
        <div class="drawer-header">
            <h3>ç·¨è¼¯é…’è­œ</h3>
            <div class="header-actions">
                <button id="closeDrawerX" class="btn-close" type="button" title="é—œé–‰">âœ•</button>
            </div>
        </div>
        <form id="editForm" class="edit-form">
            <label>æ¨™é¡Œ</label><input name="title" type="text" required>
            <label>åˆ†é¡</label><input name="category" type="text">
            <label>æ¯å‹</label><input name="glass_type" type="text">
            <label>é…’ç²¾æ¿ƒåº¦</label><input name="alcohol_content" type="text">
            <label>é›£åº¦ç­‰ç´š</label>
            <select name="difficulty">
                <option value="">é¸æ“‡é›£åº¦</option>
                <option value="ç°¡å–®">ç°¡å–®</option>
                <option value="ä¸­ç­‰">ä¸­ç­‰</option>
                <option value="å›°é›£">å›°é›£</option>
            </select>
            <label>æ¨™ç±¤ï¼ˆåˆ†è™Ÿ;åˆ†éš”ï¼‰</label><input name="tags" type="text">
            <label>é…æ–™ï¼ˆæ¯é …æ›è¡Œï¼›å„²å­˜æ™‚è‡ªå‹•ä»¥ + ä¸²æ¥ï¼‰</label><textarea name="ingredients" rows="3"></textarea>
            <label>èª¿è£½æ–¹æ³•ï¼ˆæ¯æ­¥é©Ÿæ›è¡Œï¼›å„²å­˜æ™‚ä»¥ > ä¸²æ¥ï¼‰</label><textarea name="instructions" rows="5"></textarea>
            <div class="grid-2">
                <div><label>ä»½é‡</label><input name="servings" type="number" min="1"></div>
            </div>
            <label>æ›´æ›åœ–ç‰‡ï¼ˆé¸å¡«ï¼‰</label>
            <input id="imageFile" name="image_file" type="file" accept="image/*">
            <div id="imagePreview" style="margin:8px 0;"></div>
            
            <div class="drawer-actions">
                <button id="saveCocktail" class="btn btn-primary" type="button">ğŸ’¾ å„²å­˜</button>
                <button id="cancelEdit" class="btn btn-secondary" type="button">ğŸš« å–æ¶ˆ</button>
                <button id="deleteCocktail" class="btn btn-danger" type="button">ğŸ—‘ï¸ åˆªé™¤</button>
            </div>
        </form>
    </aside>

    <script>
        // ===== æ­£è¦åŒ–å·¥å…·ï¼ˆé¿å…èˆŠè³‡æ–™å‹åˆ¥é€ æˆ .split éŒ¯èª¤ï¼‰ =====
        const COLS = ['id', 'title', 'category', 'tags', 'ingredients', 'instructions', 'glass_type', 'alcohol_content', 'difficulty', 'servings', 'image_b64'];
        function normalizeText(v) { if (Array.isArray(v)) return v.join('+'); if (v == null) return ''; return String(v); }
        function normalizeRecord(c = {}) { const out = {}; for (const k of COLS) out[k] = normalizeText(c[k]); return out; }

        // ===== IndexedDBï¼šåœ–ç‰‡èˆ‡è³‡æ–™å¿«å– =====
        class MobileStorageManager {
            constructor() { this.dbName = 'CocktailDB'; this.dbVersion = 2; this.db = null; this.imageStore = 'images'; this.cocktailStore = 'cocktails'; }
            async init() { return new Promise((resolve, reject) => { const req = indexedDB.open(this.dbName, this.dbVersion); req.onerror = () => reject(req.error); req.onsuccess = () => { this.db = req.result; resolve(this.db); }; req.onupgradeneeded = (ev) => { const db = ev.target.result; if (!db.objectStoreNames.contains(this.cocktailStore)) { const s = db.createObjectStore(this.cocktailStore, { keyPath: 'id' }); s.createIndex('title', 'title', { unique: false }); s.createIndex('category', 'category', { unique: false }); s.createIndex('tags', 'tags', { unique: false }); } if (!db.objectStoreNames.contains(this.imageStore)) { db.createObjectStore(this.imageStore, { keyPath: 'id' }); } }; }); }
            async saveCocktail(c) { return new Promise((res, rej) => { const tx = this.db.transaction(['cocktails'], 'readwrite'); const st = tx.objectStore('cocktails'); const r = st.put(c); r.onsuccess = () => res(); r.onerror = () => rej(r.error); }); }
            async getAllCocktails() { return new Promise((res, rej) => { const tx = this.db.transaction(['cocktails'], 'readonly'); const st = tx.objectStore('cocktails'); const r = st.getAll(); r.onsuccess = () => res(r.result || []); r.onerror = () => rej(r.error); }); }
            async deleteCocktail(id) { return new Promise((res, rej) => { const tx = this.db.transaction(['cocktails'], 'readwrite'); const st = tx.objectStore('cocktails'); const r = st.delete(id); r.onsuccess = () => res(); r.onerror = () => rej(r.error); }); }
            async clearAllData() { return new Promise((res, rej) => { const tx = this.db.transaction(['cocktails', 'images'], 'readwrite'); const a = tx.objectStore('cocktails').clear(); const b = tx.objectStore('images').clear(); let ok = 0; a.onsuccess = () => { ok++; if (ok === 2) res(); }; b.onsuccess = () => { ok++; if (ok === 2) res(); }; a.onerror = b.onerror = (e) => rej(e.target.error); }); }
            async saveImage(file, id) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = () => { const imageData = { id, data: reader.result, type: file.type, name: file.name, size: file.size, timestamp: Date.now() }; const tx = this.db.transaction(['images'], 'readwrite'); const st = tx.objectStore('images'); const r = st.put(imageData); r.onsuccess = () => resolve({ id, dataUrl: reader.result }); r.onerror = () => reject(r.error); }; reader.onerror = () => reject(reader.error); reader.readAsDataURL(file); }); }
            async getImage(id) { return new Promise((res, rej) => { const tx = this.db.transaction(['images'], 'readonly'); const st = tx.objectStore('images'); const r = st.get(id); r.onsuccess = () => res(r.result ? r.result.data : null); r.onerror = () => rej(r.error); }); }
            async getStorageStats() { const cocktails = await this.getAllCocktails(); const imgs = await new Promise((res, rej) => { const tx = this.db.transaction(['images'], 'readonly'); const st = tx.objectStore('images'); const r = st.getAll(); r.onsuccess = () => res(r.result || []); r.onerror = () => rej(r.error); }); const totalImageSize = imgs.reduce((s, i) => s + (i.size || 0), 0); return { cocktailCount: cocktails.length, imageCount: imgs.length, totalImageSize, formattedImageSize: this.formatBytes(totalImageSize) }; }
            formatBytes(bytes, decimals = 2) { if (bytes === 0) return '0 Bytes'; const k = 1024, dm = decimals < 0 ? 0 : decimals, sizes = ['Bytes', 'KB', 'MB', 'GB']; const i = Math.floor(Math.log(bytes) / Math.log(k)); return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i]; }
        }

        // ===== GAS å®¢æˆ¶ç«¯ï¼ˆå¢å¼·ç‰ˆï¼Œæ”¯æ´ç®¡ç†å“¡èªè­‰ï¼‰ =====
        const gas = {
            get url() { return localStorage.getItem('gasUrl') || ''; },
            set url(v) { localStorage.setItem('gasUrl', v || ''); },
            
            logDebug(message, data = null) {
                const timestamp = new Date().toLocaleTimeString();
                console.log(`[${timestamp}] [GAS] ${message}`, data || '');
                
                const debugContent = document.getElementById('debugContent');
                if (debugContent) {
                    const logEntry = `[${timestamp}] ${message}${data ? ': ' + JSON.stringify(data, null, 2).substring(0, 200) : ''}`;
                    debugContent.innerHTML = logEntry + '<br>' + debugContent.innerHTML;
                    const lines = debugContent.innerHTML.split('<br>');
                    if (lines.length > 10) {
                        debugContent.innerHTML = lines.slice(0, 10).join('<br>');
                    }
                }
            },
            
            showConnectionStatus(message, type = 'info') {
                const status = document.getElementById('connectionStatus');
                if (status) {
                    status.textContent = message;
                    status.className = `connection-status ${type}`;
                    status.classList.remove('hidden');
                    
                    if (type !== 'error') {
                        setTimeout(() => {
                            if (status.classList.contains(type)) {
                                status.classList.add('hidden');
                            }
                        }, 5000);
                    }
                }
                this.logDebug(`ç‹€æ…‹æ›´æ–° [${type}]`, message);
            },

            async validateUrl(url) {
                if (!url) return { valid: false, error: 'æœªè¨­å®š URL' };
                
                const urlPattern = /^https:\/\/script\.google\.com\/macros\/s\/[A-Za-z0-9_-]+\/exec$/;
                if (!urlPattern.test(url)) {
                    return { 
                        valid: false, 
                        error: 'URL æ ¼å¼ä¸æ­£ç¢ºï¼Œæ‡‰è©²æ˜¯: https://script.google.com/macros/s/XXX/exec' 
                    };
                }
                
                return { valid: true };
            },

            async test() {
                const urlCheck = await this.validateUrl(this.url);
                if (!urlCheck.valid) {
                    this.logDebug('URL é©—è­‰å¤±æ•—', urlCheck.error);
                    this.showConnectionStatus('âŒ« ' + urlCheck.error, 'error');
                    throw new Error(urlCheck.error);
                }
                
                this.logDebug('é–‹å§‹æ¸¬è©¦é€£ç·š', { url: this.url });
                this.showConnectionStatus('æ­£åœ¨æ¸¬è©¦é€£ç·š...', 'info');
                
                try {
                    const testUrl = `${this.url}?action=test&_t=${Date.now()}`;
                    this.logDebug('ç™¼é€æ¸¬è©¦è«‹æ±‚', { testUrl });
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 15000);
                    
                    const response = await fetch(testUrl, {
                        method: 'GET',
                        mode: 'cors',
                        cache: 'no-cache',
                        signal: controller.signal,
                        headers: {
                            'Accept': 'application/json',
                        }
                    });
                    
                    clearTimeout(timeoutId);
                    
                    this.logDebug('æ”¶åˆ°å›æ‡‰', { 
                        status: response.status, 
                        statusText: response.statusText,
                        headers: Object.fromEntries(response.headers.entries())
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const responseText = await response.text();
                    this.logDebug('å›æ‡‰å…§å®¹', responseText);
                    
                    let jsonData;
                    try {
                        jsonData = JSON.parse(responseText);
                    } catch (parseErr) {
                        this.logDebug('JSON è§£æå¤±æ•—', { responseText, error: parseErr.message });
                        throw new Error('ä¼ºæœå™¨å›æ‡‰ä¸æ˜¯æœ‰æ•ˆçš„ JSON æ ¼å¼');
                    }
                    
                    const success = jsonData.ok === true;
                    
                    if (success) {
                        this.showConnectionStatus('âœ… é€£ç·šæ¸¬è©¦æˆåŠŸ', 'success');
                        this.logDebug('æ¸¬è©¦æˆåŠŸ', jsonData);
                    } else {
                        this.showConnectionStatus('âŒ« æ¸¬è©¦å¤±æ•—: ' + (jsonData.error || 'æœªçŸ¥éŒ¯èª¤'), 'error');
                        this.logDebug('æ¸¬è©¦å¤±æ•—', jsonData);
                    }
                    
                    return success;
                    
                } catch (error) {
                    this.logDebug('æ¸¬è©¦ç•°å¸¸', { 
                        name: error.name, 
                        message: error.message,
                        stack: error.stack 
                    });
                    
                    let userMessage = 'é€£ç·šå¤±æ•—';
                    
                    if (error.name === 'AbortError') {
                        userMessage = 'è«‹æ±‚è¶…æ™‚ (15ç§’)ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š';
                    } else if (error.message.includes('CORS')) {
                        userMessage = 'CORS æ”¿ç­–éŒ¯èª¤ï¼Œè«‹ç¢ºèª Web App éƒ¨ç½²è¨­å®š';
                    } else if (error.message.includes('Failed to fetch')) {
                        userMessage = 'ç„¡æ³•é€£ç·šåˆ° Google Apps Scriptï¼Œè«‹æª¢æŸ¥ URL æ˜¯å¦æ­£ç¢º';
                    } else {
                        userMessage = error.message;
                    }
                    
                    this.showConnectionStatus('âŒ« ' + userMessage, 'error');
                    throw new Error(userMessage);
                }
            },
            
            async list() {
                const urlCheck = await this.validateUrl(this.url);
                if (!urlCheck.valid) {
                    throw new Error(urlCheck.error);
                }
                
                this.logDebug('é–‹å§‹è«‹æ±‚åˆ—è¡¨');
                this.showConnectionStatus('æ­£åœ¨å¾é›²ç«¯è®€å–è³‡æ–™...', 'info');
                
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 20000);
                    
                    const response = await fetch(`${this.url}?action=list&_t=${Date.now()}`, {
                        method: 'GET',
                        mode: 'cors',
                        cache: 'no-cache',
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    this.logDebug('åˆ—è¡¨å›æ‡‰ç‹€æ…‹', `${response.status} ${response.statusText}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const responseText = await response.text();
                    this.logDebug('åˆ—è¡¨å›æ‡‰å¤§å°', `${responseText.length} å­—å…ƒ`);
                    
                    const jsonData = JSON.parse(responseText);
                    if (!jsonData.ok) {
                        throw new Error(jsonData.error || 'list æ“ä½œå¤±æ•—');
                    }
                    
                    const count = jsonData.data ? jsonData.data.length : 0;
                    this.showConnectionStatus(`âœ… å·²è®€å– ${count} ç­†è³‡æ–™`, 'success');
                    this.logDebug('åˆ—è¡¨æˆåŠŸ', `${count} ç­†è³‡æ–™`);
                    
                    return jsonData.data || [];
                    
                } catch (error) {
                    this.logDebug('åˆ—è¡¨ç•°å¸¸', error);
                    
                    let userMessage = 'è®€å–å¤±æ•—';
                    if (error.name === 'AbortError') {
                        userMessage = 'è®€å–è¶…æ™‚ï¼Œè³‡æ–™å¯èƒ½è¼ƒå¤§æˆ–ç¶²è·¯è¼ƒæ…¢';
                    } else {
                        userMessage = error.message;
                    }
                    
                    this.showConnectionStatus('âŒ« ' + userMessage, 'error');
                    throw new Error(userMessage);
                }
            },
            
            async upsert(data) {
                const urlCheck = await this.validateUrl(this.url);
                if (!urlCheck.valid) {
                    throw new Error(urlCheck.error);
                }
                
                this.logDebug('é–‹å§‹ä¸Šå‚³è³‡æ–™', { title: data.title, id: data.id });
                this.showConnectionStatus('æ­£åœ¨å„²å­˜åˆ°é›²ç«¯...', 'info');
                
                try {
                    const payload = JSON.stringify({ action: 'upsert', data });
                    this.logDebug('ä¸Šå‚³è³‡æ–™å¤§å°', `${payload.length} å­—å…ƒ`);
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 30000);
                    
                    const response = await fetch(this.url, {
                        method: 'POST',
                        mode: 'cors',
                        headers: {
                            'Content-Type': 'text/plain',
                            'Accept': 'application/json'
                        },
                        body: payload,
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    this.logDebug('ä¸Šå‚³å›æ‡‰ç‹€æ…‹', `${response.status} ${response.statusText}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const responseText = await response.text();
                    this.logDebug('ä¸Šå‚³å›æ‡‰å…§å®¹', responseText);
                    
                    const jsonData = JSON.parse(responseText);
                    if (!jsonData.ok) {
                        throw new Error(jsonData.error || 'upsert æ“ä½œå¤±æ•—');
                    }
                    
                    this.showConnectionStatus('âœ… å„²å­˜æˆåŠŸ', 'success');
                    this.logDebug('ä¸Šå‚³æˆåŠŸ', jsonData.id);
                    
                    return jsonData.id;
                    
                } catch (error) {
                    this.logDebug('ä¸Šå‚³ç•°å¸¸', error);
                    
                    let userMessage = 'å„²å­˜å¤±æ•—';
                    if (error.name === 'AbortError') {
                        userMessage = 'ä¸Šå‚³è¶…æ™‚ï¼Œè³‡æ–™å¯èƒ½è¼ƒå¤§æˆ–ç¶²è·¯è¼ƒæ…¢';
                    } else {
                        userMessage = error.message;
                    }
                    
                    this.showConnectionStatus('âŒ« ' + userMessage, 'error');
                    throw new Error(userMessage);
                }
            },
            
            async remove(id) {
                const urlCheck = await this.validateUrl(this.url);
                if (!urlCheck.valid) {
                    throw new Error(urlCheck.error);
                }
                
                this.logDebug('é–‹å§‹åˆªé™¤è³‡æ–™', id);
                this.showConnectionStatus('æ­£åœ¨åˆªé™¤...', 'info');
                
                try {
                    const payload = JSON.stringify({ action: 'delete', id });
                    const response = await fetch(this.url, {
                        method: 'POST',
                        mode: 'cors',
                        headers: {
                            'Content-Type': 'text/plain',
                            'Accept': 'application/json'
                        },
                        body: payload
                    });
                    
                    this.logDebug('åˆªé™¤å›æ‡‰ç‹€æ…‹', `${response.status} ${response.statusText}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const responseText = await response.text();
                    this.logDebug('åˆªé™¤å›æ‡‰å…§å®¹', responseText);
                    
                    const jsonData = JSON.parse(responseText);
                    if (!jsonData.ok) {
                        throw new Error(jsonData.error || 'delete æ“ä½œå¤±æ•—');
                    }
                    
                    this.showConnectionStatus('âœ… åˆªé™¤æˆåŠŸ', 'success');
                    this.logDebug('åˆªé™¤æˆåŠŸ', id);
                    
                    return true;
                    
                } catch (error) {
                    this.logDebug('åˆªé™¤ç•°å¸¸', error);
                    this.showConnectionStatus('âŒ« åˆªé™¤å¤±æ•—: ' + error.message, 'error');
                    throw new Error(error.message);
                }
            },

            // ç®¡ç†å“¡ç™»å…¥åŠŸèƒ½
            async adminLogin(username, password) {
                const urlCheck = await this.validateUrl(this.url);
                if (!urlCheck.valid) {
                    throw new Error(urlCheck.error);
                }
                
                this.logDebug('é–‹å§‹ç®¡ç†å“¡ç™»å…¥', { username });
                
                try {
                    const payload = JSON.stringify({
                        action: 'admin_login',
                        username: username,
                        password: password
                    });
                    
                    const response = await fetch(this.url, {
                        method: 'POST',
                        mode: 'cors',
                        headers: {
                            'Content-Type': 'text/plain',
                            'Accept': 'application/json'
                        },
                        body: payload
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const responseText = await response.text();
                    const jsonData = JSON.parse(responseText);
                    
                    if (!jsonData.ok) {
                        throw new Error(jsonData.error || 'ç™»å…¥è«‹æ±‚å¤±æ•—');
                    }
                    
                    return jsonData.data;
                    
                } catch (error) {
                    this.logDebug('ç®¡ç†å“¡ç™»å…¥ç•°å¸¸', error);
                    throw new Error(error.message);
                }
            }
        };

        // ===== ç®¡ç†å“¡èªè­‰ç³»çµ± =====
        const adminAuth = {
            isAdmin: false,
            adminUser: null,
            adminToken: null,
            
            init() {
                this.loadAdminStatus();
                this.bindEvents();
                this.updateUI();
            },
            
            bindEvents() {
                document.getElementById('adminLoginBtn').addEventListener('click', () => this.showLoginModal());
                document.getElementById('adminLogoutBtn').addEventListener('click', () => this.logout());
                document.getElementById('adminLoginForm').addEventListener('submit', (e) => this.handleLogin(e));
                
                // ESC éµé—œé–‰å½ˆçª—
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && document.getElementById('adminLoginModal').classList.contains('show')) {
                        this.hideLoginModal();
                    }
                });
                
                // é»æ“Šå¤–éƒ¨é—œé–‰å½ˆçª—
                document.getElementById('adminLoginModal').addEventListener('click', (e) => {
                    if (e.target === e.currentTarget) {
                        this.hideLoginModal();
                    }
                });
            },
            
            loadAdminStatus() {
                try {
                    const savedAuth = localStorage.getItem('adminAuth');
                    if (savedAuth) {
                        const authData = JSON.parse(savedAuth);
                        if (this.isTokenValid(authData.token, authData.timestamp)) {
                            this.isAdmin = true;
                            this.adminUser = authData.user;
                            this.adminToken = authData.token;
                        } else {
                            localStorage.removeItem('adminAuth');
                        }
                    }
                } catch (e) {
                    console.warn('è¼‰å…¥ç®¡ç†å“¡ç‹€æ…‹å¤±æ•—:', e);
                    localStorage.removeItem('adminAuth');
                }
            },
            
            saveAdminStatus() {
                if (this.isAdmin && this.adminUser && this.adminToken) {
                    const authData = {
                        user: this.adminUser,
                        token: this.adminToken,
                        timestamp: Date.now()
                    };
                    localStorage.setItem('adminAuth', JSON.stringify(authData));
                } else {
                    localStorage.removeItem('adminAuth');
                }
            },
            
            isTokenValid(token, timestamp) {
                if (!token || !timestamp) return false;
                const now = Date.now();
                return (now - timestamp) < (24 * 60 * 60 * 1000);
            },
            
            showLoginModal() {
                document.getElementById('adminLoginModal').classList.add('show');
                document.getElementById('adminUsername').focus();
                this.clearMessages();
            },
            
            hideLoginModal() {
                document.getElementById('adminLoginModal').classList.remove('show');
                document.getElementById('adminLoginForm').reset();
                this.clearMessages();
            },
            
            async handleLogin(e) {
                e.preventDefault();
                
                const username = document.getElementById('adminUsername').value.trim();
                const password = document.getElementById('adminPassword').value;
                
                if (!username || !password) {
                    this.showError('è«‹è¼¸å…¥ç”¨æˆ¶åå’Œå¯†ç¢¼');
                    return;
                }
                
                try {
                    this.showMessage('æ­£åœ¨é©—è­‰...', 'info');
                    
                    const response = await gas.adminLogin(username, password);
                    
                    if (response.success && response.admin) {
                        this.isAdmin = true;
                        this.adminUser = response.user;
                        this.adminToken = response.token;
                        
                        this.saveAdminStatus();
                        this.updateUI();
                        
                        this.showSuccess('ç™»å…¥æˆåŠŸï¼ç®¡ç†å“¡æ¨¡å¼å·²å•Ÿç”¨');
                        
                        setTimeout(() => {
                            this.hideLoginModal();
                        }, 1500);
                        
                    } else {
                        this.showError(response.error || 'ç™»å…¥å¤±æ•—');
                    }
                    
                } catch (error) {
                    console.error('ç®¡ç†å“¡ç™»å…¥éŒ¯èª¤:', error);
                    this.showError('ç™»å…¥å¤±æ•—: ' + error.message);
                }
            },
            
            logout() {
                if (confirm('ç¢ºå®šè¦ç™»å‡ºç®¡ç†å“¡æ¨¡å¼å—ï¼Ÿ')) {
                    this.isAdmin = false;
                    this.adminUser = null;
                    this.adminToken = null;
                    
                    localStorage.removeItem('adminAuth');
                    this.updateUI();
                    
                    gas.showConnectionStatus('âœ… å·²ç™»å‡ºç®¡ç†å“¡æ¨¡å¼', 'success');
                }
            },
            
            updateUI() {
                const statusEl = document.getElementById('adminControls');
                const statusTextEl = document.getElementById('adminStatusText');
                const loginBtn = document.getElementById('adminLoginBtn');
                const logoutBtn = document.getElementById('adminLogoutBtn');
                
                if (this.isAdmin) {
                    statusEl.className = 'admin-controls admin-mode';
                    statusTextEl.textContent = `ç®¡ç†å“¡: ${this.adminUser?.username || 'Admin'}`;
                    loginBtn.style.display = 'none';
                    logoutBtn.style.display = 'block';
                    document.body.classList.add('admin-mode');
                    document.body.classList.remove('guest-mode');
                } else {
                    statusEl.className = 'admin-controls guest-mode';
                    statusTextEl.textContent = 'è¨ªå®¢æ¨¡å¼';
                    loginBtn.style.display = 'block';
                    logoutBtn.style.display = 'none';
                    document.body.classList.add('guest-mode');
                    document.body.classList.remove('admin-mode');
                }
                
                this.updateEditButtons();
            },
            
            updateEditButtons() {
                const editButtons = document.querySelectorAll('[onclick*="editCocktail"]');
                const addButton = document.querySelector('[data-page="add"]');
                const deleteButtons = document.querySelectorAll('#deleteCocktail');
                
                const elements = [...editButtons, addButton, ...deleteButtons].filter(Boolean);
                
                elements.forEach(button => {
                    if (this.isAdmin) {
                        button.classList.remove('edit-disabled');
                        button.removeAttribute('disabled');
                        button.title = '';
                    } else {
                        button.classList.add('edit-disabled');
                        button.setAttribute('disabled', 'disabled');
                        button.title = 'éœ€è¦ç®¡ç†å“¡æ¬Šé™';
                    }
                });
            },
            
            checkPermission(operation = 'ç·¨è¼¯') {
                if (!this.isAdmin) {
                    alert(`âš ï¸ ${operation}åŠŸèƒ½éœ€è¦ç®¡ç†å“¡æ¬Šé™\n\nè«‹å…ˆç™»å…¥ç®¡ç†å“¡å¸³è™Ÿ`);
                    this.showLoginModal();
                    return false;
                }
                return true;
            },
            
            showError(message) {
                this.showMessage(message, 'error');
            },
            
            showSuccess(message) {
                this.showMessage(message, 'success');
            },
            
            showMessage(message, type) {
                this.clearMessages();
                
                const errorEl = document.getElementById('adminLoginError');
                const successEl = document.getElementById('adminLoginSuccess');
                
                if (type === 'error') {
                    errorEl.textContent = message;
                    errorEl.style.display = 'block';
                } else if (type === 'success') {
                    successEl.textContent = message;
                    successEl.style.display = 'block';
                } else {
                    successEl.textContent = message;
                    successEl.style.display = 'block';
                }
            },
            
            clearMessages() {
                document.getElementById('adminLoginError').style.display = 'none';
                document.getElementById('adminLoginSuccess').style.display = 'none';
            }
        };

        // ===== ä¸»æ‡‰ç”¨ç¨‹å¼ =====
        class CocktailApp {
            constructor() {
                this.storage = new MobileStorageManager();
                this.cocktails = []; this.filteredCocktails = []; this.currentView = 'grid';
                this.editTargetId = null; this.pages = { browse: document.getElementById('browsePage'), add: document.getElementById('addPage'), settings: document.getElementById('settingsPage') };
                this.navButtons = Array.from(document.querySelectorAll('.nav-btn'));
                this.successMessage = null;
                this.init();
            }

            norm(v) { return (v == null ? '' : String(v)).trim().toLowerCase(); }

            async init() {
                try {
                    await this.storage.init();
                    this.bindUI();
                    await this.pullFromCloud({ silent: true });
                    if (this.cocktails.length === 0) { this.render(); }
                    this.setupPWA();
                    await this.updateStorageStats();
                    const savedUrl = gas.url; if (savedUrl) document.getElementById('gasUrl').value = savedUrl;
                    
                    // åˆå§‹åŒ–ç®¡ç†å“¡èªè­‰ç³»çµ±
                    adminAuth.init();
                } catch (err) { 
                    console.error('åˆå§‹åŒ–å¤±æ•—:', err); 
                    gas.showConnectionStatus('âŒ« åˆå§‹åŒ–å¤±æ•—: ' + err.message, 'error');
                    this.showError('åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ GAS è¨­å®šæˆ–é‡æ–°æ•´ç†ã€‚'); 
                }
            }

            bindUI() {
                const searchInput = document.getElementById('searchInput');
                const categorySelect = document.getElementById('categorySelect');
                const viewButtons = document.querySelectorAll('.view-btn');

                if (searchInput) { const onSearch = () => this.filterCocktails(); searchInput.addEventListener('input', onSearch); searchInput.addEventListener('compositionend', onSearch); }
                if (categorySelect) categorySelect.addEventListener('change', () => this.filterCocktails());
                viewButtons.forEach(btn => { btn.addEventListener('click', (e) => { viewButtons.forEach(b => b.classList.remove('active')); e.currentTarget.classList.add('active'); this.currentView = e.currentTarget.dataset.view; this.updateViewClass(); }); });

                document.getElementById('btnSync').addEventListener('click', () => this.pullFromCloud());
                document.getElementById('btnClearData').addEventListener('click', () => this.confirmClearData());

                document.getElementById('btnSaveGasUrl').addEventListener('click', async () => { 
                    const v = document.getElementById('gasUrl').value.trim(); 
                    gas.url = v; 
                    gas.showConnectionStatus('âœ… GAS URL å·²å„²å­˜', 'success');
                });
                
                document.getElementById('btnTestGas').addEventListener('click', async () => { 
                    document.getElementById('debugInfo').classList.remove('hidden');
                    try { 
                        const ok = await gas.test(); 
                    } catch (e) { 
                    } 
                });

                this.navButtons.forEach((btn) => { 
                    btn.addEventListener('click', () => { 
                        this.navButtons.forEach(b => b.classList.remove('active')); 
                        btn.classList.add('active'); 
                        const pageKey = btn.dataset.page; 
                        Object.values(this.pages).forEach(p => p.classList.remove('active')); 
                        if (this.pages[pageKey]) this.pages[pageKey].classList.add('active'); 
                        if (pageKey === 'add' && this.successMessage) this.successMessage.style.display = 'none'; 
                        if (pageKey === 'settings') this.updateStorageStats(); 
                    }); 
                });

                const form = document.getElementById('addCocktailForm');
                this.successMessage = document.getElementById('successMessage');
                form.addEventListener('submit', async (e) => { e.preventDefault(); await this.handleAdd(); });

                const tagsInput = document.getElementById('tagsInput');
                const tagsDisplay = document.getElementById('tagsDisplay');
                tagsInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && tagsInput.value.trim()) { e.preventDefault(); const tag = tagsInput.value.trim(); const chip = document.createElement('span'); chip.className = 'tag'; chip.dataset.tag = tag; chip.textContent = `#${tag} Ã—`; chip.addEventListener('click', () => chip.remove()); tagsDisplay.appendChild(chip); tagsInput.value = ''; } });

                // ç·¨è¼¯æŠ½å±œäº‹ä»¶ç¶å®š - å¢å¼·ç‰ˆ
                this.bindEditDrawerEvents();

                const addImageInput = document.getElementById('cocktailImageFile');
                const addImagePreview = document.getElementById('addImagePreview');
                addImageInput.addEventListener('change', (e) => { addImagePreview.innerHTML = ''; const file = e.target.files[0]; if (file) { const url = URL.createObjectURL(file); const img = document.createElement('img'); img.src = url; Object.assign(img.style, { maxWidth: '200px', maxHeight: '150px', borderRadius: '8px', objectFit: 'cover' }); addImagePreview.appendChild(img); } });

                document.getElementById('imageFile').addEventListener('change', (e) => { const preview = document.getElementById('imagePreview'); preview.innerHTML = ''; const file = e.target.files[0]; if (file) { const url = URL.createObjectURL(file); const img = document.createElement('img'); img.src = url; Object.assign(img.style, { maxWidth: '100%', borderRadius: '8px' }); preview.appendChild(img); const caption = document.createElement('div'); caption.textContent = 'æ–°ä¸Šå‚³çš„åœ–ç‰‡é è¦½'; Object.assign(caption.style, { fontSize: '.9rem', color: '#666', marginTop: '8px' }); preview.appendChild(caption); } });
            }

            // ç·¨è¼¯æŠ½å±œäº‹ä»¶ç¶å®š - å¢å¼·ç‰ˆ
            bindEditDrawerEvents() {
                // X æŒ‰éˆ•é—œé–‰
                document.getElementById('closeDrawerX').addEventListener('click', () => this.closeEditDrawer());
                
                // å–æ¶ˆæŒ‰éˆ•
                document.getElementById('cancelEdit').addEventListener('click', () => {
                    if (confirm('ç¢ºå®šè¦å–æ¶ˆç·¨è¼¯å—ï¼Ÿæœªå„²å­˜çš„è®Šæ›´å°‡æœƒéºå¤±ã€‚')) {
                        this.closeEditDrawer();
                    }
                });

                // å„²å­˜æŒ‰éˆ•
                document.getElementById('saveCocktail').addEventListener('click', async (e) => { 
                    e.preventDefault(); 
                    await this.saveEdited(); 
                });
                
                // åˆªé™¤æŒ‰éˆ•
                document.getElementById('deleteCocktail').addEventListener('click', async (e) => { 
                    e.preventDefault(); 
                    if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹é…’è­œå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                        await this.deleteCocktail(); 
                    }
                });
                
                // ESC éµé—œé–‰
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        const drawer = document.getElementById('editDrawer');
                        if (!drawer.classList.contains('hidden')) {
                            this.closeEditDrawer();
                        }
                    }
                });
                
                // é»æ“Šå¤–éƒ¨é—œé–‰
                document.addEventListener('click', (e) => {
                    const drawer = document.getElementById('editDrawer');
                    if (!drawer.classList.contains('hidden') && !drawer.contains(e.target)) {
                        if (!e.target.matches('[onclick*="editCocktail"]')) {
                            this.closeEditDrawer();
                        }
                    }
                });
            }

            closeEditDrawer() {
                const drawer = document.getElementById('editDrawer'); 
                drawer.classList.add('hidden'); 
                drawer.setAttribute('aria-hidden', 'true'); 
                this.editTargetId = null;
            }

            setupPWA() {
                this.updateOnlineStatus();
                window.addEventListener('online', () => this.updateOnlineStatus());
                window.addEventListener('offline', () => this.updateOnlineStatus());
                window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); this.deferredPrompt = e; document.getElementById('installPrompt').style.display = 'block'; });
                document.getElementById('installBtn').addEventListener('click', async () => { if (this.deferredPrompt) { this.deferredPrompt.prompt(); await this.deferredPrompt.userChoice; document.getElementById('installPrompt').style.display = 'none'; this.deferredPrompt = null; } });
                if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(() => { }); }); }
            }

            updateOnlineStatus() { const offlineIndicator = document.getElementById('offlineIndicator'); offlineIndicator.style.display = navigator.onLine ? 'none' : 'block'; }

            async pullFromCloud({ silent } = {}) {
                try {
                    const data = await gas.list();
                    const norm = data.map(normalizeRecord);
                    for (const c of norm) await this.storage.saveCocktail(c);
                    this.cocktails = await this.storage.getAllCocktails();
                    this.filteredCocktails = [...this.cocktails];
                    this.updateCategories();
                    this.render();
                    if (!silent) {
                        gas.showConnectionStatus(`âœ… å·²æˆåŠŸåŒæ­¥ ${this.cocktails.length} ç­†è³‡æ–™`, 'success');
                    }
                } catch (err) {
                    console.warn('é›²ç«¯è®€å–å¤±æ•—ï¼Œæ”¹ç”¨æœ¬æ©Ÿå¿«å–ï¼š', err);
                    if (!silent) {
                        gas.showConnectionStatus('âš ï¸ é›²ç«¯é€£ç·šå¤±æ•—ï¼Œé¡¯ç¤ºæœ¬æ©Ÿå¿«å–è³‡æ–™', 'warning');
                    }
                    this.cocktails = await this.storage.getAllCocktails();
                    this.filteredCocktails = [...this.cocktails];
                    this.updateCategories();
                    this.render();
                }
            }

            async handleAdd() {
                if (!adminAuth.checkPermission('æ–°å¢')) return;

                try {
                    const title = document.getElementById('cocktailTitle').value.trim();
                    const category = document.getElementById('cocktailCategory').value.trim();
                    const glassType = document.getElementById('glassType').value.trim();
                    const alcoholContent = document.getElementById('alcoholContent').value.trim();
                    const difficulty = document.getElementById('difficulty').value.trim();
                    const servings = document.getElementById('servings').value.trim();
                    const chips = Array.from(document.querySelectorAll('#tagsDisplay .tag')).map(x => x.dataset.tag);
                    const tags = chips.join(';');
                    const ingredients = Array.from(document.querySelectorAll('#ingredientsList .ingredient-item input')).map(i => i.value.trim()).filter(Boolean).join('+');
                    const instructions = Array.from(document.querySelectorAll('#instructionsList .instruction-item input')).map(i => i.value.trim()).filter(Boolean).join('>');
                    if (!title) return alert('è«‹è¼¸å…¥é›å°¾é…’åç¨±');
                    if (!ingredients) return alert('è«‹è‡³å°‘è¼¸å…¥ä¸€é …é…æ–™');
                    if (!instructions) return alert('è«‹è‡³å°‘è¼¸å…¥ä¸€å€‹æ­¥é©Ÿ');
                    let image_b64 = '';
                    const imageFile = document.getElementById('cocktailImageFile').files[0];
                    const newId = this.makeId();
                    if (imageFile) { try { const saved = await this.storage.saveImage(imageFile, newId); image_b64 = saved.dataUrl; } catch (err) { console.warn('åœ–ç‰‡å¿«å–å¤±æ•—ï¼ˆä¸å½±éŸ¿æ–‡å­—è³‡æ–™ï¼‰ï¼š', err); } }
                    const rec = { id: newId, title, category, tags, ingredients, instructions, glass_type: glassType, alcohol_content: alcoholContent || '', difficulty: difficulty || '', servings: servings || '', image_b64 };
                    const recNorm = normalizeRecord(rec);
                    await gas.upsert(recNorm);
                    await this.storage.saveCocktail(recNorm);
                    await this.pullFromCloud({ silent: true });
                    this.render();
                    this.successMessage.style.display = 'block';
                    const browseBtn = this.navButtons.find(b => b.dataset.page === 'browse'); browseBtn?.click();
                    this.clearForm();
                } catch (err) { 
                    console.error('æ–°å¢å¤±æ•—ï¼š', err); 
                    gas.showConnectionStatus('âŒ« æ–°å¢å¤±æ•—: ' + err.message, 'error');
                    alert('æ–°å¢å¤±æ•—ï¼š' + err.message); 
                }
            }

            makeId() { return 'C' + String(Date.now()); }

            async editCocktail(id) {
                if (!adminAuth.checkPermission('ç·¨è¼¯')) return;

                const c = this.cocktails.find(r => r.id === id); if (!c) return;
                this.editTargetId = id;
                const f = document.getElementById('editForm');
                f.title.value = c.title || ''; f.category.value = c.category || ''; f.glass_type.value = c.glass_type || ''; f.alcohol_content.value = c.alcohol_content || ''; f.difficulty.value = c.difficulty || ''; f.tags.value = c.tags || ''; f.ingredients.value = String(c.ingredients || '').replace(/\+/g, '\n'); f.instructions.value = String(c.instructions || '').replace(/>/g, '\n'); f.servings.value = c.servings || '';
                const preview = document.getElementById('imagePreview'); preview.innerHTML = '';
                try { const src = await this.storage.getImage(c.id); if (src) { const img = document.createElement('img'); img.src = src; Object.assign(img.style, { maxWidth: '100%', borderRadius: '8px', marginBottom: '8px' }); preview.appendChild(img); const caption = document.createElement('div'); caption.textContent = 'ç›®å‰çš„åœ–ç‰‡'; Object.assign(caption.style, { fontSize: '.9rem', color: '#666' }); preview.appendChild(caption); } } catch (e) { console.warn('è¼‰å…¥åœ–ç‰‡å¤±æ•—ï¼š', e); }
                const drawer = document.getElementById('editDrawer'); drawer.classList.remove('hidden'); drawer.setAttribute('aria-hidden', 'false');
            }

            async saveEdited() {
                try {
                    const idx = this.cocktails.findIndex(r => r.id === this.editTargetId); if (idx === -1) return;
                    const f = document.getElementById('editForm');
                    let image_b64 = this.cocktails[idx].image_b64 || '';
                    const imageFile = document.getElementById('imageFile').files[0];
                    if (imageFile) { try { const saved = await this.storage.saveImage(imageFile, this.editTargetId); image_b64 = saved.dataUrl; } catch (e) { console.warn('åœ–ç‰‡æ›´æ–°å¿«å–å¤±æ•—ï¼š', e); } }
                    const updated = {
                        ...this.cocktails[idx], title: f.title.value.trim(), category: f.category.value.trim(), glass_type: f.glass_type.value.trim(), alcohol_content: f.alcohol_content.value || '', difficulty: f.difficulty.value || '', tags: f.tags.value.trim(), ingredients: f.ingredients.value.trim().replace(/\n/g, '+'), instructions: f.instructions.value.trim().replace(/\n/g, '>'), servings: f.servings.value || '', image_b64
                    };
                    const updatedNorm = normalizeRecord(updated);
                    await gas.upsert(updatedNorm);
                    await this.storage.saveCocktail(updatedNorm);
                    await this.pullFromCloud({ silent: true });
                    this.render();
                    this.closeEditDrawer();
                    gas.showConnectionStatus('âœ… ç·¨è¼¯å„²å­˜æˆåŠŸ', 'success');
                } catch (err) { 
                    console.error('å„²å­˜ç·¨è¼¯å¤±æ•—ï¼š', err); 
                    gas.showConnectionStatus('âŒ« å„²å­˜å¤±æ•—: ' + err.message, 'error');
                    alert('å„²å­˜å¤±æ•—ï¼š' + err.message); 
                }
            }

            async deleteCocktail() {
                try { 
                    const id = this.editTargetId; 
                    await gas.remove(id); 
                    await this.storage.deleteCocktail(id); 
                    await this.pullFromCloud({ silent: true }); 
                    this.render(); 
                    this.closeEditDrawer();
                    gas.showConnectionStatus('âœ… åˆªé™¤æˆåŠŸ', 'success');
                } catch (err) { 
                    console.error('åˆªé™¤å¤±æ•—ï¼š', err); 
                    gas.showConnectionStatus('âŒ« åˆªé™¤å¤±æ•—: ' + err.message, 'error');
                    alert('åˆªé™¤å¤±æ•—ï¼š' + err.message); 
                }
            }

            addIngredient() { const wrap = document.getElementById('ingredientsList'); const div = document.createElement('div'); div.className = 'ingredient-item'; div.innerHTML = `<input type="text" placeholder="ä¾‹å¦‚ï¼šç´…é…’ 60ml" required /><button type="button" class="remove-btn">ç§»é™¤</button>`; div.querySelector('.remove-btn').addEventListener('click', () => div.remove()); wrap.appendChild(div); }
            removeIngredient(btn) { btn.closest('.ingredient-item')?.remove(); }

            addInstruction() { const wrap = document.getElementById('instructionsList'); const idx = wrap.querySelectorAll('.instruction-item').length + 1; const div = document.createElement('div'); div.className = 'instruction-item'; div.innerHTML = `<span style="font-weight:bold;min-width:30px;">${idx}.</span><input type="text" placeholder="è©³ç´°æè¿°æ­¥é©Ÿ" required /><button type="button" class="remove-btn">ç§»é™¤</button>`; div.querySelector('.remove-btn').addEventListener('click', () => { div.remove(); Array.from(wrap.querySelectorAll('.instruction-item span')).forEach((s, i) => s.textContent = (i + 1) + '.'); }); wrap.appendChild(div); }
            removeInstruction(btn) { btn.closest('.instruction-item')?.remove(); }

            clearForm() { document.getElementById('addCocktailForm').reset(); document.getElementById('tagsDisplay').innerHTML = ''; document.getElementById('addImagePreview').innerHTML = ''; document.getElementById('ingredientsList').innerHTML = `<div class="ingredient-item"><input type="text" placeholder="ä¾‹å¦‚ï¼šç´…é…’ 60ml" required /><button type="button" class="remove-btn" onclick="app.removeIngredient(this)">ç§»é™¤</button></div>`; document.getElementById('instructionsList').innerHTML = `<div class="instruction-item"><span style="font-weight: bold; min-width: 30px;">1.</span><input type="text" placeholder="è©³ç´°æè¿°ç¬¬ä¸€å€‹æ­¥é©Ÿ" required /><button type="button" class="remove-btn" onclick="app.removeInstruction(this)">ç§»é™¤</button></div>`; }

            updateCategories() { const sel = document.getElementById('categorySelect'); if (!sel) return; const categories = [...new Set(this.cocktails.map(r => (r.category || '').trim()).filter(Boolean))].sort(); sel.querySelectorAll('option:not(:first-child)').forEach(o => o.remove()); categories.forEach(c => { const opt = document.createElement('option'); opt.value = c; opt.textContent = c; sel.appendChild(opt); }); }

            filterCocktails() { const searchTerm = this.norm(document.getElementById('searchInput')?.value || ''); const selectedCategoryRaw = document.getElementById('categorySelect')?.value || ''; const selectedCategory = (selectedCategoryRaw || '').trim(); if (!Array.isArray(this.cocktails)) this.cocktails = []; this.filteredCocktails = this.cocktails.filter(r => { const title = this.norm(r?.title); const tags = this.norm(r?.tags); const ingredients = this.norm(r?.ingredients); const category = (r?.category || '').trim(); const matchesSearch = !searchTerm || title.includes(searchTerm) || tags.includes(searchTerm) || ingredients.includes(searchTerm); const matchesCategory = !selectedCategory || category === selectedCategory; return matchesSearch && matchesCategory; }); this.render(); }

            updateViewClass() { const container = document.getElementById('cocktailsContainer'); container.className = this.currentView === 'grid' ? 'cocktails-grid' : 'cocktails-list'; }

            updateStats() { const stats = document.getElementById('stats'); const total = this.cocktails.length, showing = this.filteredCocktails.length; stats.textContent = `é¡¯ç¤º ${showing} / ${total} é“é›å°¾é…’è­œ`; }

            renderCocktails() {
                const container = document.getElementById('cocktailsContainer');
                if (this.filteredCocktails.length === 0) { container.innerHTML = `<div class="empty-state"><div class="icon">ğŸ”</div><h3>æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„é›å°¾é…’è­œ</h3><p>è©¦è‘—èª¿æ•´æœå°‹é—œéµå­—æˆ–åˆ†é¡ç¯©é¸</p></div>`; return; }
                container.innerHTML = this.filteredCocktails.map(c => {
                    const tagsHtml = (c.tags ? String(c.tags).split(';').map(tag => `<span class="tag">${tag.trim()}</span>`).join('') : '');
                    const glassType = c.glass_type || '', alcoholContent = c.alcohol_content || '', difficulty = c.difficulty || '';
                    const ingredientsList = Array.isArray(c.ingredients) ? c.ingredients : String(c.ingredients ?? '').split('+');
                    const instructionsList = Array.isArray(c.instructions) ? c.instructions : String(c.instructions ?? '').split('>');
                    return `
        <div class="cocktail-card">
          <div class="cocktail-image">${c.image_b64 ? `<img src="${c.image_b64}" alt="${c.title}">` : 'ğŸ¸'}</div>
          <div class="cocktail-content">
            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px;">
              <h3 class="cocktail-title">${c.title || ''}</h3>
              <button onclick="app.editCocktail('${c.id}')" class="btn edit-only" style="font-size:.8rem; padding:4px 8px;">ç·¨è¼¯</button>
            </div>
            <div class="cocktail-meta">
              ${glassType ? `<span class="meta-item">ğŸ¥ƒ ${glassType}</span>` : ''}
              ${alcoholContent ? `<span class="meta-item">ğŸŒ¡ï¸ ${alcoholContent}</span>` : ''}
              ${difficulty ? `<span class="meta-item">â­ ${difficulty}</span>` : ''}
              <span class="meta-item">ğŸ‘¥ ${c.servings || '1'} æ¯</span>
            </div>
            ${tagsHtml ? `<div class="cocktail-tags">${tagsHtml}</div>` : ''}
            <div class="cocktail-details">
              <details><summary>ğŸ¥ƒ é…æ–™æ¸…å–®</summary><div class="ingredients-list">${ingredientsList.filter(Boolean).map(i => `<div>â€¢ ${String(i).trim()}</div>`).join('')}</div></details>
              <details><summary>ğŸ´ èª¿è£½æ–¹æ³•</summary><div class="instructions-list">${instructionsList.filter(Boolean).map(s => `<div class="instruction">${String(s).trim()}</div>`).join('')}</div></details>
            </div>
          </div>
        </div>`;
                }).join('');
            }

            render() { 
                this.updateStats(); 
                this.renderCocktails(); 
                this.updateViewClass(); 
            }

            async updateStorageStats() { 
                try { 
                    const s = await this.storage.getStorageStats(); 
                    const el = document.getElementById('storageStats'); 
                    if (el) { 
                        el.innerHTML = `<p><strong>é…’è­œæ•¸é‡ï¼š</strong> ${s.cocktailCount} å€‹</p><p><strong>åœ–ç‰‡æ•¸é‡ï¼š</strong> ${s.imageCount} å¼µ</p><p><strong>åœ–ç‰‡å¤§å°ï¼š</strong> ${s.formattedImageSize}</p><p><strong>æœ€å¾Œæ›´æ–°ï¼š</strong> ${new Date().toLocaleString('zh-TW')}</p>`; 
                    } 
                } catch (e) { 
                    console.warn('çµ±è¨ˆå¤±æ•—ï¼š', e); 
                } 
            }

            async confirmClearData() { 
                if (confirm('âš ï¸ ç¢ºå®šè¦æ¸…é™¤æœ¬æ©Ÿå¿«å–å—ï¼Ÿä¸å½±éŸ¿é›²ç«¯è³‡æ–™ã€‚')) { 
                    try { 
                        await this.storage.clearAllData(); 
                        this.cocktails = []; 
                        this.filteredCocktails = []; 
                        this.updateCategories(); 
                        this.render(); 
                        await this.updateStorageStats(); 
                        gas.showConnectionStatus('âœ… æœ¬æ©Ÿå¿«å–å·²æ¸…é™¤', 'success'); 
                    } catch (err) { 
                        alert('æ¸…é™¤å¤±æ•—ï¼š' + err.message); 
                    } 
                } 
            }

            async migrateLocalData() { 
                const all = await this.storage.getAllCocktails(); 
                for (const c of all) { 
                    const fixed = normalizeRecord(c); 
                    await this.storage.saveCocktail(fixed); 
                } 
                this.cocktails = await this.storage.getAllCocktails(); 
                this.filteredCocktails = [...this.cocktails]; 
                this.render(); 
                alert('âœ… å·²å®Œæˆæœ¬æ©Ÿè³‡æ–™æ ¼å¼é·ç§»'); 
            }

            showError(msg) { alert(msg); }
        }

        // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
        const app = new CocktailApp();
        window.app = app;
        
        // å…¨åŸŸå‡½æ•¸ï¼šæª¢æŸ¥ç®¡ç†å“¡æ¬Šé™
        window.requireAdmin = function(operation = 'æ­¤æ“ä½œ') {
            return adminAuth.checkPermission(operation);
        };
        
        // æš´éœ²èª¿è©¦å‡½æ•¸åˆ°å…¨åŸŸ
        window.gasDebug = {
            test: () => gas.test(),
            list: () => gas.list(),
            upload: (data) => gas.upsert(data),
            showUrl: () => console.log('GAS URL:', gas.url),
            clearLogs: () => {
                const debugContent = document.getElementById('debugContent');
                if (debugContent) debugContent.innerHTML = 'å·²æ¸…é™¤æ—¥èªŒ';
            },
            adminLogin: (username, password) => gas.adminLogin(username, password),
            checkAdmin: () => console.log('Admin Status:', {
                isAdmin: adminAuth.isAdmin,
                user: adminAuth.adminUser,
                token: adminAuth.adminToken ? 'Present' : 'None'
            })
        };
    </script>
</body>

</html>

